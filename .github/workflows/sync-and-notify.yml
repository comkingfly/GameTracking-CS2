name: Sync and Notify CS2 Updates

on:
  schedule:
    # æ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆæœ€å¿«é¢‘ç‡ï¼‰
    - cron: '*/5 * * * *'
    # æˆ–è€…æ¯ 10 åˆ†é’Ÿï¼š'*/10 * * * *'
    # æˆ–è€…æ¯å°æ—¶ï¼š'0 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  sync-and-notify:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä½ çš„ fork
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²
          
      # 2. æ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶è·å–æœ€æ–°å†…å®¹
      - name: Sync with upstream
        id: sync
        run: |
          # æ·»åŠ ä¸Šæ¸¸ä»“åº“
          git remote add upstream https://github.com/SteamDatabase/GameTracking-CS2.git || true
          
          # è·å–ä¸Šæ¸¸æœ€æ–°å†…å®¹
          git fetch upstream master
          
          # è·å–å½“å‰æœ¬åœ°æœ€æ–° commit SHA
          CURRENT_SHA=$(git rev-parse HEAD)
          echo "current_sha=$CURRENT_SHA"
          
          # è·å–ä¸Šæ¸¸æœ€æ–° commit SHA
          UPSTREAM_SHA=$(git rev-parse upstream/master)
          echo "upstream_sha=$UPSTREAM_SHA"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ›´æ–°
          if [ "$CURRENT_SHA" != "$UPSTREAM_SHA" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            
            # è·å–æ–° commit çš„è¯¦ç»†ä¿¡æ¯
            COMMIT_MESSAGE=$(git log upstream/master -1 --pretty=format:"%s")
            COMMIT_AUTHOR=$(git log upstream/master -1 --pretty=format:"%an")
            COMMIT_DATE=$(git log upstream/master -1 --pretty=format:"%ci")
            COMMIT_URL="https://github.com/SteamDatabase/GameTracking-CS2/commit/$UPSTREAM_SHA"
            
            echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
            echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
            echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
            echo "commit_url=$COMMIT_URL" >> $GITHUB_OUTPUT
            echo "commit_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
            
            # åˆå¹¶ä¸Šæ¸¸æ›´æ–°
            git merge upstream/master --ff-only
            
            # æ¨é€åˆ°ä½ çš„ fork
            git push origin master
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
          
      # 3. å‘é€ Discord é€šçŸ¥ï¼ˆä»…å½“æœ‰æ›´æ–°æ—¶ï¼‰
      - name: Send Discord notification
        if: steps.sync.outputs.has_updates == 'true'
        run: |
          curl -H "Content-Type: application/json" \
               -d "{
                 \"content\": \"@everyone\",
                 \"embeds\": [{
                   \"title\": \"ğŸ® CS2 ä»“åº“æœ‰æ–°æ›´æ–°ï¼\",
                   \"description\": \"${{ steps.sync.outputs.commit_message }}\",
                   \"url\": \"${{ steps.sync.outputs.commit_url }}\",
                   \"color\": 3447003,
                   \"fields\": [
                     {
                       \"name\": \"ğŸ“ æäº¤è€…\",
                       \"value\": \"${{ steps.sync.outputs.commit_author }}\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"ğŸ•’ æäº¤æ—¶é—´\",
                       \"value\": \"${{ steps.sync.outputs.commit_date }}\",
                       \"inline\": true
                     },
                     {
                       \"name\": \"ğŸ”— Commit SHA\",
                       \"value\": \"\`${{ steps.sync.outputs.commit_sha }}\`\"
                     }
                   ],
                   \"footer\": {
                     \"text\": \"SteamDatabase/GameTracking-CS2\"
                   },
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK }}
